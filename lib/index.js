'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.imageZip=exports.fileZip=exports.fileToImage=exports.dataURLToImage=exports.fileToDataURL=undefined;var _extends2=require('babel-runtime/helpers/extends');var _extends3=_interopRequireDefault(_extends2);var _promise=require('babel-runtime/core-js/promise');var _promise2=_interopRequireDefault(_promise);var _exifJs=require('exif-js');var _exifJs2=_interopRequireDefault(_exifJs);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var fileToDataURL=exports.fileToDataURL=function fileToDataURL(file){if(!hasImage(file))throw Error('\u5165\u53C2\u5FC5\u987B\u662F\u4E00\u4E2Aimage\u7C7B\u578B\u7684file');return new _promise2.default(function(resolve,reject){var reader=new FileReader;reader.onload=function(){return resolve(reader.result)};reader.onerror=function(err){return reject(err)};reader.readAsDataURL(file)})};var dataURLToImage=exports.dataURLToImage=function dataURLToImage(url){if(typeString(url)!=='string')throw Error('\u5165\u53C2\u4E0D\u662F\u5B57\u7B26\u4E32');return new _promise2.default(function(resolve,reject){var image=new Image;image.src=url;image.onload=function(){return resolve(image)};image.onerror=function(err){return reject(err)}})};var fileToImage=exports.fileToImage=function fileToImage(file,isRotate){if(!isRotate){return fileToDataURL(file).then(function(url){return dataURLToImage(url)})}else{return fileToDataURL(file).then(function(url){return dataURLToImage(url)}).then(function(image){return(0,_extends3.default)({image:image},imageToCanvas(image))}).then(function(res){return rotateImgViaExif(res)})}};var fileZip=exports.fileZip=function fileZip(file){var quality=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0.8;if(!hasImage(file))throw Error('\u5165\u53C2\u5FC5\u987B\u662F\u4E00\u4E2Aimage\u7C7B\u578B\u7684file');return new _promise2.default(function(resolve,reject){fileToImage(file).then(function(image){var _imageToCanvas=imageToCanvas(image),canvas=_imageToCanvas.canvas;canvas.toBlob(function(blob){return resolve(blob)},'image/jpeg',quality)}).catch(function(err){return reject(err)})})};var imageZip=exports.imageZip=function imageZip(image){var quality=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0.8;var _imageToCanvas2=imageToCanvas(image),canvas=_imageToCanvas2.canvas;var url=canvas.toDataURL(image,quality);return dataURLToImage(url)};function rotateImgViaExif(params){var image=params.image,canvas=params.canvas,ctx=params.ctx;return getRotateDeg(image).then(function(rotateDeg){ctx.translate(canvas.width/2,canvas.height/2);ctx.rotate(rotateDeg);var url=canvas.toDataURL(image);return dataURLToImage(url)})}var rotate={6:90*Math.PI/180,8:-90*Math.PI/180,3:180*Math.PI/180};function getRotateDeg(image){return new _promise2.default(function(resolve){_exifJs2.default.getData(image,function(){var orientation=this.exifdata.Orientation;console.log(orientation);if(typeof orientation==='undefined'||orientation===1)return resolve(0);var rotateDeg=hasProp(rotate,orientation)?rotate[orientation]:0;resolve(rotateDeg)})})}function imageToCanvas(image){var canvas=document.createElement('canvas');var ctx=canvas.getContext('2d');var w=image.naturalWidth;var h=image.naturalHeight;canvas.width=w;canvas.height=h;ctx.drawImage(image,0,0,w,h);return{canvas:canvas,ctx:ctx}}function typeString(anw){return Object.prototype.toString.call(anw).slice(8,-1).toLowerCase()}function hasImage(file){return typeString(file)==='file'&&file.type.match(/image/)}function hasProp(obj,key){Object.prototype.hasOwnProperty.call(obj,key)}